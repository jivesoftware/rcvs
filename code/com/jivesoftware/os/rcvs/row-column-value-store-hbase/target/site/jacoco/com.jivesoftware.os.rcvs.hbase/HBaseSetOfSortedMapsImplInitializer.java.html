<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HBaseSetOfSortedMapsImplInitializer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">row-column-value-store-hbase</a> &gt; <a href="index.html" class="el_package">com.jivesoftware.os.rcvs.hbase</a> &gt; <span class="el_source">HBaseSetOfSortedMapsImplInitializer.java</span></div><h1>HBaseSetOfSortedMapsImplInitializer.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2013 Jive Software, Inc
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package com.jivesoftware.os.rcvs.hbase;

import com.jivesoftware.os.rcvs.api.RowColumnValueStore;
import com.jivesoftware.os.rcvs.api.RowColumnValueStoreMarshaller;
import com.jivesoftware.os.rcvs.api.SetOfSortedMapsImplInitializer;
import com.jivesoftware.os.rcvs.api.timestamper.Timestamper;
import java.io.IOException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import org.apache.hadoop.hbase.client.HTablePool;
import org.merlin.config.Config;
import org.merlin.config.defaults.IntDefault;
import org.merlin.config.defaults.StringDefault;

public class HBaseSetOfSortedMapsImplInitializer implements SetOfSortedMapsImplInitializer&lt;Exception&gt; {

    private static final int POOL_SIZE = Integer.MAX_VALUE;

    static public interface HBaseSetOfSortedMapsConfig extends Config {

        @StringDefault (&quot;unspecifiedHBaseZookeeperQuorum&quot;)
        public String getHBaseZookeeperQuorum();
        public void setHBaseZookeeperQuorum(String hbaseZookeeperQuorum);

        @IntDefault (2181)
        public Integer getHBaseZookeeperPort();
        public void setHBaseZookeeperPort(Integer hbaseZookeeperPort);

        @IntDefault(24)
        int getMarshalThreadPoolSize();
        public void setMarshalThreadPoolSize(int marshalThreadPoolSize);
    }
    private final org.apache.hadoop.conf.Configuration hbaseConfig;
    private final ExecutorService marshalExecutor;

    public HBaseSetOfSortedMapsImplInitializer(HBaseSetOfSortedMapsConfig config) {
<span class="nc" id="L52">        this(config, defaultHbaseConfig(config));</span>
<span class="nc" id="L53">        defaultHbaseConfig(config);</span>
<span class="nc" id="L54">    }</span>

<span class="nc" id="L56">    public HBaseSetOfSortedMapsImplInitializer(HBaseSetOfSortedMapsConfig config, org.apache.hadoop.conf.Configuration hbaseConfig) {</span>
<span class="nc" id="L57">        this.hbaseConfig = hbaseConfig;</span>
<span class="nc" id="L58">        this.marshalExecutor = Executors.newFixedThreadPool(config.getMarshalThreadPoolSize());</span>
<span class="nc" id="L59">    }</span>

    private static org.apache.hadoop.conf.Configuration defaultHbaseConfig(HBaseSetOfSortedMapsConfig config) {
<span class="nc" id="L62">        org.apache.hadoop.conf.Configuration hbaseConfig = new org.apache.hadoop.conf.Configuration();</span>
<span class="nc" id="L63">        hbaseConfig.clear();</span>
<span class="nc" id="L64">        hbaseConfig.set(&quot;hbase.zookeeper.quorum&quot;, config.getHBaseZookeeperQuorum());</span>
<span class="nc" id="L65">        hbaseConfig.set(&quot;hbase.zookeeper.property.clientPort&quot;, String.valueOf(config.getHBaseZookeeperPort()));</span>
<span class="nc" id="L66">        return hbaseConfig;</span>
    }

    @Override
    public &lt;T, R, C, V&gt; RowColumnValueStore&lt;T, R, C, V, Exception&gt; initialize(
        String tableNameSpace, String tableName, String columnFamilyName,
        RowColumnValueStoreMarshaller&lt;T, R, C, V&gt; marshaller,
        Timestamper timestamper) throws IOException {
<span class="nc" id="L74">        HBaseTableConfiguration hBaseTableConfiguration = new HBaseTableConfiguration(</span>
            hbaseConfig,
            tableNameSpace,
            tableName,
            columnFamilyName);

<span class="nc" id="L80">        hBaseTableConfiguration.ensureTableProvisioned(true);</span>

<span class="nc" id="L82">        return new HBaseSetOfSortedMapsImpl&lt;&gt;(</span>
            new HTablePool(hbaseConfig, POOL_SIZE),
            hBaseTableConfiguration.getFinalName(),
            hBaseTableConfiguration.getColumnFamilyName(),
            marshaller,
            timestamper, marshalExecutor);
    }

    @Override
    public &lt;T, R, C, V&gt; RowColumnValueStore&lt;T, R, C, V, Exception&gt; initialize(String tableNameSpace, String tableName, String columnFamilyName,
        String[] additionalColumnFamilies, RowColumnValueStoreMarshaller&lt;T, R, C, V&gt; marshaller, Timestamper timestamper) throws IOException {

<span class="nc" id="L94">        String[] columnFamilies = new String[additionalColumnFamilies.length + 1];</span>
<span class="nc" id="L95">        columnFamilies[0] = columnFamilyName;</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        for (int i = 0; i &lt; additionalColumnFamilies.length; i++) {</span>
<span class="nc" id="L97">            columnFamilies[i + 1] = additionalColumnFamilies[i];</span>
        }

<span class="nc" id="L100">        HBaseTableConfiguration hBaseTableConfiguration = new HBaseTableConfiguration(</span>
            hbaseConfig,
            tableNameSpace,
            tableName,
            columnFamilies);

<span class="nc" id="L106">        hBaseTableConfiguration.ensureTableProvisioned(true, true);</span>

<span class="nc" id="L108">        return new HBaseSetOfSortedMapsImpl&lt;&gt;(</span>
            new HTablePool(hbaseConfig, POOL_SIZE),
            hBaseTableConfiguration.getFinalName(),
            hBaseTableConfiguration.getColumnFamilyName(),
            marshaller,
            timestamper, marshalExecutor);
    }

    @Override
    public &lt;T, R, C, V&gt; RowColumnValueStore&lt;T, R, C, V, Exception&gt; initialize(
        String tableNameSpace, String tableName, String columnFamilyName,
        int ttlInSeconds, int minVersions, int maxVersions,
        RowColumnValueStoreMarshaller&lt;T, R, C, V&gt; marshaller,
        Timestamper timestamper) throws IOException {
<span class="nc" id="L122">        HBaseTableConfiguration hBaseTableConfiguration = new HBaseTableConfiguration(</span>
            hbaseConfig,
            tableNameSpace, tableName, columnFamilyName,
            ttlInSeconds, minVersions, maxVersions);

<span class="nc" id="L127">        hBaseTableConfiguration.ensureTableProvisioned(true);</span>

<span class="nc" id="L129">        return new HBaseSetOfSortedMapsImpl&lt;&gt;(</span>
            new HTablePool(hbaseConfig, POOL_SIZE),
            hBaseTableConfiguration.getFinalName(),
            hBaseTableConfiguration.getColumnFamilyName(),
            marshaller,
            timestamper, marshalExecutor);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>